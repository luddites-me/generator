---
platform: linux
image_resource:
  type: registry-image
  source: { repository: node, tag: "12" }
inputs:
  - name: generator-protect-integration-master
run:
  path: /bin/sh
  args:
    - -c
    - |
      # install JQ for easier version parsing
      apt-get update
      apt-get -y install jq

      mkdir ~/.ssh && chmod 700 ~/.ssh
      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
      echo "$SSH_KEY" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
      ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub

      echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc

      cd generator-protect-integration-master

      # Ensure we are on the correct branch and not just the latest HEAD commit
      git checkout ctdoriott/ch19775/add-concourse-builds-for-all-sdk-repos-missing-a-concourse-config

      git config --global user.email 'noreply@ns8.com'
      git config --global user.name 'Concourse CI'

      # prevent infinite loop from version bumping via ci
      if git log | head -n 2 | tail -n 1 | grep 'Concourse CI'
      then
        exit 0
      fi

      # Make sure all yarn components are installed
      if ! yarn install
      then
        echo "ERROR: yarn install failed"
        exit 1
      fi

      # Publish package to yarn
      if ! yarn publish --patch
      then
        echo "ERROR: yarn pusblish failed"
        exit 1
      fi

      # Get the latest version value and update info in GitHub
      current_version=$(yarn info --json | jq -r '.["data"]["dist-tags"]["latest"]')
      git push origin HEAD
      git tag -a $version_increment -m "Automatic version tag: $version_increment"
      git push origin $version_increment
